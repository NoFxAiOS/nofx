name: Auto Sync with Official Repository

on:
  schedule:
    # æ¯6å°æ—¶è‡ªåŠ¨åŒæ­¥ä¸€æ¬¡ (UTCæ—¶é—´)
    - cron: '0 */6 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]

env:
  OFFICIAL_REPO: NoFxAiOS/nofx
  OUR_REPO: yu704176671/nofx13

jobs:
  sync-official:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout our repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@users.noreply.github.com"

    - name: Add official repository as remote
      run: |
        git remote add official https://github.com/${{ env.OFFICIAL_REPO }}.git

    - name: Fetch official changes
      run: |
        git fetch official

    - name: Check for new commits
      id: check_commits
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æäº¤
        COMMITS_AHEAD=$(git rev-list --count official/main..HEAD)
        COMMITS_BEHIND=$(git rev-list --count HEAD..official/main)
        
        echo "We are $COMMITS_AHEAD commits ahead, $COMMITS_BEHIND commits behind official"
        
        if [ $COMMITS_BEHIND -gt 0 ]; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "commit_count=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
        else
          echo "changes=false" >> $GITHUB_OUTPUT
        fi

    - name: Create sync branch
      if: steps.check_commits.outputs.changes == 'true'
      run: |
        BRANCH_NAME="sync/official-$(date +%Y%m%d-%H%M%S)"
        git checkout -b $BRANCH_NAME
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

    - name: Merge official changes
      if: steps.check_commits.outputs.changes == 'true'
      run: |
        # å°è¯•åˆå¹¶å®˜æ–¹æ›´æ”¹
        git merge official/main --no-edit --strategy-option theirs || true
        
        # æ£€æŸ¥å¹¶è§£å†³å†²çª
        if git diff --name-only --diff-filter=U | grep -q .; then
          echo "âš ï¸ æ£€æµ‹åˆ°åˆå¹¶å†²çªï¼Œä½¿ç”¨æ™ºèƒ½è§£å†³ç­–ç•¥..."
          
          # å¯¹äºç‰¹å®šæ–‡ä»¶ä½¿ç”¨æ™ºèƒ½åˆå¹¶
          for conflicted_file in $(git diff --name-only --diff-filter=U); do
            echo "å¤„ç†å†²çªæ–‡ä»¶: $conflicted_file"
            
            case $conflicted_file in
              "app.py")
                echo "ä½¿ç”¨æ™ºèƒ½åˆå¹¶ç­–ç•¥å¤„ç† app.py"
                python .github/scripts/smart-merge.py $conflicted_file
                ;;
              "requirements.txt")
                echo "ä½¿ç”¨ä¾èµ–åˆå¹¶ç­–ç•¥å¤„ç† requirements.txt" 
                python .github/scripts/merge-requirements.py
                ;;
              "Dockerfile")
                echo "ä¿ç•™æˆ‘ä»¬çš„ Dockerfile é…ç½®"
                git checkout --ours $conflicted_file
                ;;
              "README.md")
                echo "ä¿ç•™æˆ‘ä»¬çš„ README.md"
                git checkout --ours $conflicted_file
                ;;
              *)
                echo "é»˜è®¤ç­–ç•¥: ä½¿ç”¨å®˜æ–¹ç‰ˆæœ¬ - $conflicted_file"
                git checkout --theirs $conflicted_file
                ;;
            esac
            
            git add $conflicted_file
          done
          
          # æäº¤å†²çªè§£å†³æ–¹æ¡ˆ
          git commit -m "ğŸ”„ è§£å†³åˆå¹¶å†²çª: æ™ºèƒ½ä¿ç•™è‡ªå®šä¹‰åŠŸèƒ½" || echo "æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
        fi

    - name: Push sync branch
      if: steps.check_commits.outputs.changes == 'true'
      run: |
        git push origin ${{ env.branch_name }}

    - name: Create Pull Request
      if: steps.check_commits.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥å®˜æ–¹ä»“åº“æ›´æ–°"
        title: "ğŸ”— åŒæ­¥å®˜æ–¹ä»“åº“æ›´æ–° (${{ steps.check_commits.outputs.commit_count }} ä¸ªæ–°æäº¤)"
        body: |
          ## è‡ªåŠ¨åŒæ­¥æŠ¥å‘Š
          
          æ­¤ PR è‡ªåŠ¨ä»å®˜æ–¹ä»“åº“ [NoFxAiOS/nofx](https://github.com/NoFxAiOS/nofx) åŒæ­¥æ›´æ–°ã€‚
          
          ### åŒæ­¥è¯¦æƒ…:
          - **æ–°æäº¤æ•°é‡**: ${{ steps.check_commits.outputs.commit_count }}
          - **åŒæ­¥æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **åŒæ­¥åˆ†æ”¯**: ${{ env.branch_name }}
          
          ### åˆå¹¶ç­–ç•¥:
          - âœ… **app.py**: æ™ºèƒ½åˆå¹¶ (ä¿ç•™è®¤è¯ç³»ç»Ÿ + å®˜æ–¹äº¤æ˜“åŠŸèƒ½)
          - âœ… **requirements.txt**: ä¾èµ–åˆå¹¶
          - âœ… **Dockerfile**: ä¿ç•™æˆ‘ä»¬çš„éƒ¨ç½²é…ç½®
          - âœ… **README.md**: ä¿ç•™æˆ‘ä»¬çš„æ–‡æ¡£
          - ğŸ”„ **å…¶ä»–æ–‡ä»¶**: ä½¿ç”¨å®˜æ–¹ç‰ˆæœ¬
          
          ### éœ€è¦äººå·¥æ£€æŸ¥:
          1. æµ‹è¯•ç”¨æˆ·è®¤è¯åŠŸèƒ½
          2. éªŒè¯äº¤æ˜“ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
          3. æ£€æŸ¥ Web ç•Œé¢å®Œæ•´æ€§
          4. ç¡®è®¤éƒ¨ç½²é…ç½®æ­£ç¡®
          
          ### å¿«é€Ÿæµ‹è¯•å‘½ä»¤:
          ```bash
          # æµ‹è¯•åº”ç”¨å¯åŠ¨
          docker build -t test-sync .
          docker run -e SUPABASE_URL=test -e SUPABASE_ANON_KEY=test test-sync --help
          ```
          
          ---
          *æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*
        branch: ${{ env.branch_name }}
        base: main

    - name: Notify on success
      if: steps.check_commits.outputs.changes == 'true'
      run: |
        echo "âœ… åŒæ­¥å®Œæˆï¼å·²åˆ›å»º PR: ${{ env.branch_name }}"

    - name: Notify no changes
      if: steps.check_commits.outputs.changes == 'false'
      run: |
        echo "âœ… å®˜æ–¹ä»“åº“æ— æ–°æ›´æ–°ï¼Œä¿æŒåŒæ­¥çŠ¶æ€"

  # åŒæ­¥åè‡ªåŠ¨æµ‹è¯•
  test-after-sync:
    runs-on: ubuntu-latest
    needs: sync-official
    if: needs.sync-official.outputs.changes == 'true'
    
    steps:
    - name: Checkout sync branch
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.sync-official.outputs.branch_name }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Test application imports
      run: |
        pip install -r requirements.txt
        python -c "
        try:
            import streamlit, supabase, pandas, plotly, jwt, requests
            print('âœ… æ‰€æœ‰ä¾èµ–å¯¼å…¥æˆåŠŸ')
        except ImportError as e:
            print(f'âŒ å¯¼å…¥é”™è¯¯: {e}')
            exit(1)
        "

    - name: Syntax check
      run: |
        python -m py_compile app.py
        echo "âœ… Python è¯­æ³•æ£€æŸ¥é€šè¿‡"

    - name: Update test status
      run: |
        echo "âœ… åŒæ­¥åæµ‹è¯•å®Œæˆï¼ŒPR å·²å‡†å¤‡å°±ç»ª"
