name: Sync and Deploy to Hugging Face

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 è‡ªåŠ¨åŒæ­¥ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # åŒæ­¥å®˜æ–¹ä»“åº“æ›´æ–°
  sync-upstream:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@users.noreply.github.com"

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/NoFxAiOS/nofx.git

    - name: Fetch upstream changes
      run: |
        git fetch upstream

    - name: Merge upstream changes
      run: |
        git checkout dev
        git merge upstream/dev --no-edit || true
        git push origin dev

    - name: Create Sync PR if needed
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦åŒæ­¥çš„æ›´æ”¹
        if git diff --quiet HEAD upstream/dev; then
          echo "No changes to sync"
          exit 0
        fi
        
        # åˆ›å»ºåŒæ­¥åˆ†æ”¯å¹¶æ¨é€
        git checkout -b sync-upstream-$(date +%Y%m%d-%H%M%S)
        git push origin HEAD
        
        # åˆ›å»º PR (éœ€è¦ GitHub CLI)
        gh pr create \
          --base main \
          --head "$(git branch --show-current)" \
          --title "ğŸ”„ Sync upstream changes from NoFxAiOS/nofx" \
          --body "Automated sync from upstream repository" \
          --reviewer "${{ github.actor }}"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ„å»ºå’Œæµ‹è¯•
  build-and-test:
    runs-on: ubuntu-latest
    needs: sync-upstream
    
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Check Python syntax
      run: |
        python -m py_compile app.py
        python -m py_compile supabase_config.py

    - name: Test imports
      run: |
        python -c "
        import sys
        try:
            import streamlit
            import supabase
            import pandas
            import plotly
            import jwt
            print('âœ… All dependencies imported successfully')
        except ImportError as e:
            print(f'âŒ Import error: {e}')
            sys.exit(1)
        "

    - name: Run security check
      run: |
        pip install bandit
        bandit -r . -f json -o bandit-report.json || true

  # Docker æ„å»ºæ£€æŸ¥
  docker-build:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t nofx13-trading .

    - name: Test Docker image
      run: |
        # æµ‹è¯•é•œåƒæ„å»ºå’ŒåŸºæœ¬è¿è¡Œ
        docker run --rm -e SUPABASE_URL=test -e SUPABASE_ANON_KEY=test nofx13-trading --help || echo "Docker test completed"

    - name: Scan Docker image
      run: |
        docker scan nofx13-trading || true

  # éƒ¨ç½²åˆ° Hugging Face
  deploy-huggingface:
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Push to Hugging Face
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Configure Hugging Face CLI
      run: |
        pip install huggingface_hub
        huggingface-cli login --token ${{ secrets.HF_TOKEN }}

    - name: Deploy to Spaces
      run: |
        # å…‹éš† Space ä»“åº“ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -n "${{ secrets.HF_SPACE_REPO }}" ]; then
          git clone https://huggingface.co/spaces/${{ secrets.HF_SPACE_REPO }} hf-space
          cd hf-space
          cp ../app.py .
          cp ../requirements.txt .
          cp ../Dockerfile .
          cp ../README.md .
          
          git config user.name "GitHub Actions"
          git config user.email "actions@users.noreply.github.com"
          git add .
          git commit -m "ğŸ”„ Auto-update from GitHub (${{ github.sha }})" || echo "No changes to commit"
          git push
        else
          echo "HF_SPACE_REPO secret not set, skipping Space update"
        fi

  # PR æ£€æŸ¥
  pr-checks:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: PR Size Check
      run: |
        # æ£€æŸ¥ PR å¤§å°
        ADDED_LINES=$(git diff --numstat ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | awk '{sum += $1} END {print sum}')
        DELETED_LINES=$(git diff --numstat ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | awk '{sum += $2} END {print sum}')
        TOTAL_CHANGES=$((ADDED_LINES + DELETED_LINES))
        
        echo "Changes: +${ADDED_LINES} -${DELETED_LINES} (Total: ${TOTAL_CHANGES})"
        
        if [ $TOTAL_CHANGES -gt 1000 ]; then
          echo "âŒ PR is too large (>1000 lines). Please split into smaller PRs."
          exit 1
        else
          echo "âœ… PR size is acceptable"
        fi

    - name: Check for large files
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰å¤§æ–‡ä»¶
        find . -type f -size +10M -not -path "./.git/*" | while read file; do
          echo "âŒ Large file detected: $file"
          exit 1
        done || echo "âœ… No large files detected"

  # å¥åº·æ£€æŸ¥
  health-check:
    runs-on: ubuntu-latest
    needs: deploy-huggingface
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Wait for deployment
      run: sleep 60

    - name: Health check
      run: |
        if [ -n "${{ secrets.HF_SPACE_URL }}" ]; then
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.HF_SPACE_URL }})
          if [ "$response" -eq 200 ]; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed: HTTP $response"
            exit 1
          fi
        else
          echo "HF_SPACE_URL not set, skipping health check"
        fi

  # é€šçŸ¥
  notification:
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build, health-check]
    if: always()
    
    steps:
    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ CI/CD Pipeline failed"
        # è¿™é‡Œå¯ä»¥é›†æˆ Slackã€Discord ç­‰é€šçŸ¥
        # ä¾‹å¦‚ï¼šcurl -X POST -H 'Content-type: application/json' --data '{"text":"ğŸš¨ NoFx13 CI/CD Failed!"}' $SLACK_WEBHOOK_URL

    - name: Notify on success
      if: success()
      run: |
        echo "âœ… CI/CD Pipeline completed successfully"
