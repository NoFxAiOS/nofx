name: Sync Official to Dev Branch

on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时自动同步一次
  workflow_dispatch:  # 手动触发

jobs:
  sync-dev:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: dev
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@users.noreply.github.com"

      - name: Add upstream repository
        run: |
          git remote add upstream https://github.com/NoFxAiOS/nofx.git
          git fetch upstream

      - name: Show sync information
        run: |
          echo "=== 同步信息 ==="
          echo "官方仓库最新提交:"
          git log -1 --oneline upstream/main
          echo ""
          echo "当前dev分支提交:"
          git log -1 --oneline HEAD
          echo ""
          echo "开始同步..."

      - name: Backup custom workflows and configurations
        run: |
          # 创建备份目录
          mkdir -p .github/backup
          
          # 备份所有自定义工作流和配置文件
          echo "备份自定义文件..."
          
          # 备份工作流文件
          if [ -d ".github/workflows" ]; then
            cp -r .github/workflows/* .github/backup/ 2>/dev/null || echo "没有工作流文件需要备份"
          fi
          
          # 备份其他自定义配置文件（如果有）
          [ -f "README.md" ] && cp README.md .github/backup/README_backup.md
          [ -f ".gitignore" ] && cp .gitignore .github/backup/gitignore_backup
          
          echo "✅ 自定义文件备份完成"
          ls -la .github/backup/

      - name: Reset to official main branch
        run: |
          # 强制重置到官方main分支
          git reset --hard upstream/main
          echo "✅ 已重置到官方main分支"

      - name: Restore custom workflows
        run: |
          # 恢复自定义的工作流文件
          echo "恢复自定义工作流文件..."
          
          if [ -d ".github/backup" ]; then
            # 恢复工作流目录
            mkdir -p .github/workflows
            cp -r .github/backup/* .github/workflows/ 2>/dev/null || echo "没有工作流文件需要恢复"
            
            # 清理备份的README和gitignore（我们不恢复这些）
            rm -f .github/workflows/README_backup.md 2>/dev/null || true
            rm -f .github/workflows/gitignore_backup 2>/dev/null || true
            
            echo "✅ 自定义工作流文件已恢复"
            ls -la .github/workflows/
          else
            echo "⚠️ 没有找到备份文件"
          fi

      - name: Commit and push changes
        run: |
          # 添加所有更改
          git add .
          
          # 检查是否有更改需要提交
          if git diff-index --quiet HEAD --; then
            echo "✅ 没有更改需要提交"
          else
            git commit -m "Sync: Official updates with preserved custom workflows [Automated]"
            git push origin dev
            echo "✅ 已提交并推送到dev分支"
          fi

      - name: Deploy to Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "开始部署到 Hugging Face..."
          pip install huggingface_hub
          
          python -c "
          from huggingface_hub import HfApi
          import os
          api = HfApi(token=os.environ['HF_TOKEN'])
          try:
              api.upload_folder(
                  folder_path='.',
                  repo_id='lcy1313/nofxbishenjiqir',
                  repo_type='space',
                  commit_message='Sync: Official updates with custom workflows'
              )
              print('✅ 已成功部署到 Hugging Face Space')
          except Exception as e:
              print(f'❌ 部署失败: {e}')
              exit(1)
          "
