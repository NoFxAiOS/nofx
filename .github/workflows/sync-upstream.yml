name: Smart Sync with Custom Features

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: '强制同步（覆盖自定义修改）'
        required: false
        default: 'false'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Identify custom files
        run: |
          # 创建自定义文件列表（根据您的实际情况调整）
          echo "custom_app.py" >> .github/custom-files.txt
          echo "custom_utils.py" >> .github/custom-files.txt
          echo "custom_modules/" >> .github/custom-files.txt
          echo "my_features.py" >> .github/custom-files.txt

      - name: Backup custom files
        run: |
          mkdir -p .github/custom-backup
          while IFS= read -r file; do
            if [ -e "$file" ]; then
              if [ -d "$file" ]; then
                cp -r "$file" ".github/custom-backup/"
              else
                cp "$file" ".github/custom-backup/"
              fi
              echo "已备份: $file"
            fi
          done < .github/custom-files.txt

      - name: Sync from upstream
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@users.noreply.github.com"
          
          git remote add upstream https://github.com/NoFxAiOS/nofx.git
          git fetch upstream
          
          # 根据输入决定同步方式
          if [ "${{ github.event.inputs.force_sync }}" = "true" ]; then
            echo "执行强制同步..."
            git reset --hard upstream/main
          else
            echo "执行智能合并..."
            git merge upstream/main --no-commit --no-ff || echo "合并可能有冲突"
          fi

      - name: Restore and integrate custom features
        run: |
          # 恢复自定义文件
          if [ -d ".github/custom-backup" ]; then
            cp -r .github/custom-backup/* ./
            echo "自定义文件已恢复"
          fi
          
          # 检查并报告合并状态
          if git status | grep -q "Unmerged paths"; then
            echo "❌ 检测到合并冲突，需要手动解决"
            echo "冲突文件:"
            git diff --name-only --diff-filter=U
            exit 1
          else
            echo "✅ 同步完成，无冲突"
          fi

      - name: Commit and push
        run: |
          git add .
          git commit -m "Auto-sync: $(date +'%Y-%m-%d %H:%M') with custom features" || echo "无新更改"
          git push origin main

      - name: Deploy to HF
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          pip install huggingface_hub
          python -c "
          from huggingface_hub import HfApi
          import os
          api = HfApi(token=os.environ['HF_TOKEN'])
          api.upload_folder(
              folder_path='.',
              repo_id='lcy1313/nofxbishenjiqir',
              repo_type='space',
              commit_message='Updated with latest sync'
          )
          "
