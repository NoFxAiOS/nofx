name: Sync from Official Repository

on:
  schedule:
    - cron: '0 */6 * * *'  # 每6小时自动同步
  workflow_dispatch:  # 手动触发

jobs:
  sync-official:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@users.noreply.github.com"

      - name: Add upstream repository
        run: |
          git remote add upstream https://github.com/NoFxAiOS/nofx.git
          git fetch upstream

      - name: Show upstream status
        run: |
          echo "当前分支: $(git branch --show-current)"
          echo "上游仓库最新提交:"
          git log -1 --oneline upstream/main
          echo "当前仓库最新提交:"
          git log -1 --oneline origin/main

      - name: Merge upstream changes
        run: |
          # 尝试合并上游更新
          git merge upstream/main --no-commit --no-ff || echo "可能有合并冲突需要处理"
          
          # 检查合并状态
          if git status | grep -q "Unmerged paths"; then
            echo "❌ 检测到合并冲突，需要手动解决"
            echo "冲突文件:"
            git diff --name-only --diff-filter=U
            exit 1
          fi

      - name: Commit and push changes
        run: |
          if git status --porcelain | grep -q "M"; then
            git add .
            git commit -m "Sync: Update from official repository $(date +'%Y-%m-%d %H:%M')"
            git push origin main
            echo "✅ 已同步官方更新并推送到仓库"
          else
            echo "✅ 已是最新版本，无需更新"
          fi

      - name: Deploy to Hugging Face
        if: success()
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          echo "开始部署到 Hugging Face..."
          pip install huggingface_hub
          
          # 部署到您的 Space
          python -c "
          from huggingface_hub import HfApi
          import os
          api = HfApi(token=os.environ['HF_TOKEN'])
          api.upload_folder(
              folder_path='.',
              repo_id='lcy1313/nofxbishenjiqir',
              repo_type='space',
              commit_message='Auto-deploy after upstream sync'
          )
          "
          echo "✅ 已部署到 Hugging Face Space"
