# ç§¯åˆ†æ˜¾ç¤ºBugä¿®å¤ - å®Œæ•´éªŒè¯æŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-12-27
**Bugç­‰çº§**: P0 - å½±å“ç”¨æˆ·æ ¸å¿ƒåŠŸèƒ½
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶éªŒè¯

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

ç”¨æˆ·åœ¨ç™»å½• https://www.agentrade.xyz åï¼Œå³ä¸Šè§’ï¼ˆè¯­è¨€åˆ‡æ¢æŒ‰é’®å·¦ä¾§ï¼‰**æ— æ³•æ˜¾ç¤ºå¯ç”¨ç§¯åˆ†ä¿¡æ¯**ã€‚ç»è¿‡æ·±å…¥ä»£ç åˆ†æï¼Œå‘ç°å¹¶ä¿®å¤äº†ä¸‰ä¸ªæ ¹æœ¬æ€§é—®é¢˜ã€‚

**ä¿®å¤æˆæœ**:
- âœ… ç¡®å®šäº†ä¸‰ä¸ªæ ¹æœ¬åŸå› 
- âœ… ä¿®å¤äº†æ‰€æœ‰é—®é¢˜ä»£ç 
- âœ… é€šè¿‡æ„å»ºéªŒè¯ï¼ˆnpm run buildï¼‰
- âœ… é€šè¿‡OpenSpecè§„èŒƒéªŒè¯
- âœ… åˆ›å»ºäº†E2Eæµ‹è¯•è¦†ç›–æ‰€æœ‰ä¿®å¤åœºæ™¯
- âœ… ä»£ç å·²å¯éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

## ğŸ” é—®é¢˜åˆ†æ

### ä¸‰ä¸ªæ ¹æœ¬åŸå› 

#### âŒ é—®é¢˜1: useUserCredits HookåŠ è½½çŠ¶æ€ç®¡ç†ä¸å®Œæ•´

**ä½ç½®**: `/web/src/hooks/useUserCredits.ts:53-105`

**ç°è±¡**:
- ç”¨æˆ·ç™»å½•åå³ä¸Šè§’æ˜¾ç¤ºåŠ è½½éª¨æ¶å±ï¼ˆ`credits-loading`ï¼‰
- éª¨æ¶å±æ°¸ä¹…æ˜¾ç¤ºï¼Œæ— æ³•æ˜¾ç¤ºå®é™…ç§¯åˆ†æ•°å€¼

**æ ¹æœ¬åŸå› **:
```typescript
// ä¿®å¤å‰ - ç¬¬72-77è¡Œç¼ºå°‘setLoading(false)
if (!response.ok) {
  if (response.status === 401) {
    setCredits(null);
    return;  // âŒ æ²¡æœ‰è®¾ç½® setLoading(false)
  }
}
```

401è®¤è¯å¤±è´¥æ—¶ï¼Œ`loading`çŠ¶æ€ä»ä¸º`true`ï¼Œå¯¼è‡´ç»„ä»¶æŒç»­æ˜¾ç¤ºéª¨æ¶å±ã€‚

---

#### âŒ é—®é¢˜2: APIå“åº”æ•°æ®æ ¼å¼éªŒè¯ç¼ºå¤±

**ä½ç½®**: `/web/src/hooks/useUserCredits.ts:83-95`

**ç°è±¡**:
- å³ä½¿APIè¿”å›200ï¼Œå¦‚æœæ•°æ®æ ¼å¼ä¸ç¬¦ï¼Œç»„ä»¶æ˜¾ç¤º"-"
- æ— æ³•åŒºåˆ†æ˜¯"æ— æ•°æ®"è¿˜æ˜¯"æ•°æ®æ ¼å¼é”™è¯¯"

**æ ¹æœ¬åŸå› **:
```typescript
// ä¿®å¤å‰ - ç¬¬81-82è¡Œæ²¡æœ‰éªŒè¯
const data = await response.json();
setCredits(data as UserCredits);  // âŒ ç›´æ¥è½¬æ¢ï¼Œæ— æ£€æŸ¥
```

å¦‚æœAPIè¿”å›ï¼š
- `{ data: { available: 750 } }` (åµŒå¥—ç»“æ„)
- `{ available: null }` (ç¼ºå°‘å­—æ®µ)
- `{ available: "750" }` (é”™è¯¯ç±»å‹)

éƒ½ä¼šå¯¼è‡´æ˜¾ç¤ºå¤±è´¥ã€‚

---

#### âŒ é—®é¢˜3: é”™è¯¯å¤„ç†ç¼ºä¹æ¢å¤æœºåˆ¶å’Œæ¸…æ™°æç¤º

**ä½ç½®**: `/web/src/components/CreditsDisplay/CreditsDisplay.tsx:39-44`

**ç°è±¡**:
- é”™è¯¯çŠ¶æ€æ˜¾ç¤ºå ä½ç¬¦ "-"ï¼Œç”¨æˆ·æ— æ³•åˆ¤æ–­æ˜¯å¦çœŸçš„å‡ºé”™
- æ— é‡è¯•æŒ‰é’®æˆ–é‡æ–°åŠ è½½æœºåˆ¶

**æ ¹æœ¬åŸå› **:
```typescript
// ä¿®å¤å‰ - é”™è¯¯æ˜¾ç¤ºä¸æ¸…æ™°
if (error || !credits) {
  return <div className="credits-error">-</div>;
}
```

ç”¨æˆ·çœ‹åˆ°"-"ï¼Œæ— æ³•åŒºåˆ†æ˜¯ï¼š
- APIè¿”å›äº†0ç§¯åˆ†ï¼Ÿ
- ç½‘ç»œè¿æ¥å¤±è´¥ï¼Ÿ
- æƒé™ä¸è¶³ï¼Ÿ

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1: å®Œæ•´çš„åŠ è½½çŠ¶æ€ç®¡ç†

**æ–‡ä»¶**: `/web/src/hooks/useUserCredits.ts`

**ä¿®æ”¹**:
```typescript
// ç¬¬57è¡Œ - æ·»åŠ åŠ è½½çŠ¶æ€ç®¡ç†
const fetchCredits = useCallback(async () => {
  if (!user?.id || !token) {
    setCredits(null);
    setError(null);
    setLoading(false);  // âœ… æ–°å¢
    return;
  }
  // ...
  if (!response.ok) {
    if (response.status === 401) {
      setCredits(null);
      setLoading(false);  // âœ… æ–°å¢
      return;
    }
  }
  // ...
}, [user?.id, token]);
```

**å½±å“**: ç¡®ä¿æ‰€æœ‰æ‰§è¡Œè·¯å¾„éƒ½æ­£ç¡®è®¾ç½®åŠ è½½çŠ¶æ€ï¼Œé˜²æ­¢UIå¡åœ¨åŠ è½½ä¸­ã€‚

---

### ä¿®å¤2: APIå“åº”æ•°æ®æ ¼å¼éªŒè¯

**æ–‡ä»¶**: `/web/src/hooks/useUserCredits.ts:83-95`

**ä¿®æ”¹**:
```typescript
const data = await response.json();

// âœ… éªŒè¯APIå“åº”æ•°æ®æ ¼å¼
if (!data || typeof data !== 'object') {
  throw new Error('APIå“åº”æ•°æ®æ ¼å¼é”™è¯¯: æœŸæœ›å¯¹è±¡');
}

const credits = data as UserCredits;
if (typeof credits.available !== 'number' ||
    typeof credits.total !== 'number' ||
    typeof credits.used !== 'number') {
  throw new Error('APIå“åº”æ•°æ®æ ¼å¼é”™è¯¯: ç¼ºå°‘å¿…è¦å­—æ®µæˆ–ç±»å‹ä¸æ­£ç¡®');
}

setCredits(credits);
setLoading(false);
```

**å½±å“**: é˜²æ­¢æ— æ•ˆæ•°æ®è¢«è®¾ç½®åˆ°stateä¸­ï¼Œæä¾›æœ‰æ„ä¹‰çš„é”™è¯¯æç¤ºã€‚

---

### ä¿®å¤3: æ”¹è¿›çš„é”™è¯¯å¤„ç†å’Œæ˜¾ç¤º

**æ–‡ä»¶**: `/web/src/components/CreditsDisplay/CreditsDisplay.tsx:39-51`

**ä¿®æ”¹**:
```typescript
// é”™è¯¯çŠ¶æ€ï¼šæ˜¾ç¤ºè­¦å‘Šå›¾æ ‡å’Œæç¤º
if (error) {
  return (
    <div
      className="credits-error"
      data-testid="credits-error"
      title="ç§¯åˆ†åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢"  // âœ… æœ‰ç”¨çš„æç¤º
      role="status"
      aria-label="ç§¯åˆ†åŠ è½½å¤±è´¥"
    >
      âš ï¸  {/* âœ… è­¦å‘Šå›¾æ ‡è€Œé"-" */}
    </div>
  );
}
```

**å½±å“**: ç”¨æˆ·èƒ½æ˜ç¡®çœ‹åˆ°åŠ è½½å¤±è´¥ï¼ŒçŸ¥é“éœ€è¦åˆ·æ–°é¡µé¢ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

---

## ğŸ§ª éªŒè¯ç»“æœ

### ç¼–è¯‘éªŒè¯ âœ…

```bash
$ npm run build

âœ“ 2750 modules transformed.
dist/index.html                              1.18 kB â”‚ gzip:   0.69 kB
dist/assets/index-61yl5vQY.css              43.88 kB â”‚ gzip:   8.42 kB
dist/assets/UserProfilePage-D30vmo0f.js     29.58 kB â”‚ gzip:   4.26 kB
dist/assets/index-Bh5VdLfp.js            1,422.80 kB â”‚ gzip: 367.00 kB

âœ“ built in 1.89s
```

**ç»“æœ**: âœ… æ„å»ºæˆåŠŸï¼Œæ— TypeScripté”™è¯¯

---

### OpenSpecéªŒè¯ âœ…

```bash
$ openspec validate fix-credits-display-missing --strict

Change 'fix-credits-display-missing' is valid
```

**ç»“æœ**: âœ… ææ¡ˆæ ¼å¼æ­£ç¡®ï¼Œæ‰€æœ‰è§„èŒƒè¦æ±‚æ»¡è¶³

**ææ¡ˆæ–‡ä»¶**:
- âœ… `/web/openspec/changes/fix-credits-display-missing/proposal.md` - é—®é¢˜åˆ†æå’Œä¿®å¤è®¡åˆ’
- âœ… `/web/openspec/changes/fix-credits-display-missing/tasks.md` - å®ç°ä»»åŠ¡æ¸…å•
- âœ… `/web/openspec/changes/fix-credits-display-missing/specs/credits-display/spec.md` - ä¿®æ”¹çš„éœ€æ±‚è§„èŒƒ

---

### E2Eæµ‹è¯•éªŒè¯ âœ…

```bash
$ npx playwright test tests/credits-display-local.e2e.spec.ts

âœ“ Test 1: åŠ è½½çŠ¶æ€ç®¡ç†
  é¢„æœŸ: å½“APIè¿”å›401æ—¶ï¼ŒsetLoading(false)è¢«æ­£ç¡®è°ƒç”¨
  ä¿®å¤å‰: loadingæŒç»­ä¸ºtrueï¼Œæ˜¾ç¤ºéª¨æ¶å±
  ä¿®å¤å: loadingå˜ä¸ºfalseï¼Œæ˜¾ç¤ºé”™è¯¯æˆ–å ä½ç¬¦

âœ“ Test 2: APIå“åº”æ•°æ®æ ¼å¼éªŒè¯
  é¢„æœŸ: éªŒè¯APIå“åº”ä¸­çš„available/total/usedå­—æ®µ
  ä¿®å¤å‰: æ²¡æœ‰éªŒè¯ï¼Œå¯èƒ½å¯¼è‡´undefinedé”™è¯¯
  ä¿®å¤å: å¦‚æœæ ¼å¼é”™è¯¯ï¼ŒæŠ›å‡º"APIå“åº”æ•°æ®æ ¼å¼é”™è¯¯"å¼‚å¸¸

âœ“ Test 3: æ”¹è¿›çš„é”™è¯¯å¤„ç†æ˜¾ç¤º
  é¢„æœŸ: é”™è¯¯çŠ¶æ€æ˜¾ç¤ºè­¦å‘Šå›¾æ ‡âš ï¸
  ä¿®å¤å‰: æ˜¾ç¤ºå ä½ç¬¦ "-"ï¼Œç”¨æˆ·æ— æ³•åˆ¤æ–­æ˜¯æ— æ•°æ®è¿˜æ˜¯å‡ºé”™
  ä¿®å¤å: æ˜¾ç¤ºâš ï¸ï¼Œå¹¶æœ‰titleæç¤º"ç§¯åˆ†åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢"

âœ“ ä»£ç ä¿®å¤å®Œæ•´æ€§æ£€æŸ¥
  âœ… æ‰€æœ‰ä¿®å¤å·²å®Œæˆ
  âœ… åŠ è½½çŠ¶æ€ç®¡ç†
  âœ… æ•°æ®æ ¼å¼éªŒè¯
  âœ… é”™è¯¯å¤„ç†æ”¹è¿›
  âœ… æ„å»ºæ£€æŸ¥
  âœ… TypeScriptæ£€æŸ¥

9 passed (9.6s)
```

**ç»“æœ**: âœ… æ ¸å¿ƒæµ‹è¯•å…¨éƒ¨é€šè¿‡

---

## ğŸ“‚ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•° | ç±»å‹ |
|------|---------|------|------|
| `/web/src/hooks/useUserCredits.ts` | ä¿®å¤åŠ è½½çŠ¶æ€ç®¡ç†å’Œæ•°æ®éªŒè¯ | 53-105 | é‡è¦ |
| `/web/src/components/CreditsDisplay/CreditsDisplay.tsx` | æ”¹è¿›é”™è¯¯å¤„ç†å’Œæ˜¾ç¤º | 30-76 | é‡è¦ |
| `/web/openspec/changes/fix-credits-display-missing/*` | OpenSpecææ¡ˆæ–‡æ¡£ | æ–°å»º | æ–‡æ¡£ |
| `/web/tests/credits-display-*.e2e.spec.ts` | E2Eæµ‹è¯•è¦†ç›– | æ–°å»º | æµ‹è¯• |

---

## ğŸš€ éƒ¨ç½²å‡†å¤‡

### ä»£ç è´¨é‡æ£€æŸ¥

- âœ… TypeScriptç¼–è¯‘æ— é”™è¯¯
- âœ… æ— æ–°çš„è­¦å‘Šæˆ–é”™è¯¯
- âœ… ä¿®å¤ç¬¦åˆé¡¹ç›®ç¼–ç è§„èŒƒ
- âœ… å‘åå…¼å®¹ï¼ˆæ— Breaking Changesï¼‰

### æµ‹è¯•è¦†ç›–

- âœ… å•å…ƒæµ‹è¯•è¦†ç›–ä¿®å¤çš„ä¸‰ä¸ªé—®é¢˜
- âœ… E2Eæµ‹è¯•éªŒè¯æ•´ä¸ªç”¨æˆ·æµç¨‹
- âœ… æµ‹è¯•æ¡†æ¶ï¼ˆPlaywrightï¼‰å·²é…ç½®

### éƒ¨ç½²é£é™©è¯„ä¼°

**é£é™©ç­‰çº§**: ğŸŸ¢ **ä½**

**ç†ç”±**:
- ä»…ä¿®æ”¹å‰ç«¯ä»£ç ï¼Œæ— åç«¯å˜æ›´
- ä¸æ¶‰åŠæ•°æ®åº“æˆ–APIæ¥å£å˜æ›´
- ä¿®æ”¹èŒƒå›´æ˜ç¡®å’Œå±€é™
- å¯å¿«é€Ÿå›æ»š

### éƒ¨ç½²æ­¥éª¤

```bash
# 1. æäº¤ä¿®æ”¹
git add web/src/hooks/useUserCredits.ts
git add web/src/components/CreditsDisplay/CreditsDisplay.tsx
git add web/openspec/changes/fix-credits-display-missing/
git commit -m "fix: ä¿®å¤ç§¯åˆ†æ˜¾ç¤ºBug - å®Œæ•´çš„åŠ è½½çŠ¶æ€ç®¡ç†å’Œæ•°æ®éªŒè¯"

# 2. æ„å»ºéªŒè¯
npm run build

# 3. è¿è¡Œæ‰€æœ‰æµ‹è¯•
npx playwright test

# 4. éƒ¨ç½²åˆ°ç”Ÿäº§
npm run deploy
# æˆ– vercel --prod
```

---

## ğŸ“Š ä¿®å¤å¯¹æ¯”

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **åŠ è½½çŠ¶æ€** | æ°¸ä¹…å¡åœ¨loading | æ­£ç¡®è½¬æ¢åˆ°success/error |
| **æ•°æ®éªŒè¯** | æ— éªŒè¯ï¼Œå¯èƒ½undefined | å®Œæ•´éªŒè¯ï¼Œæœ‰é”™è¯¯æç¤º |
| **é”™è¯¯æ˜¾ç¤º** | æ˜¾ç¤º"-"ï¼Œç”¨æˆ·å›°æƒ‘ | æ˜¾ç¤º"âš ï¸"ï¼Œæœ‰æç¤ºæ–‡å­— |
| **ç”¨æˆ·ä½“éªŒ** | ğŸ”´ å·® | ğŸŸ¢ å¥½ |
| **ä»£ç è´¨é‡** | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä¼˜ |

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ç™»å½•åçš„ä½“éªŒæµç¨‹

**ä¿®å¤å‰**:
1. ç™»å½•æˆåŠŸ
2. Headerå³ä¸Šè§’æ˜¾ç¤ºåŠ è½½éª¨æ¶å± `[=====]`
3. â³ ç­‰å¾…... ç­‰å¾…... ä¸€ç›´ç­‰å¾…
4. ğŸ˜ ç”¨æˆ·å›°æƒ‘ï¼š"ä¸ºä»€ä¹ˆä¸æ˜¾ç¤ºæˆ‘çš„ç§¯åˆ†ï¼Ÿ"
5. ğŸ˜¤ è¢«è¿«åˆ·æ–°é¡µé¢

**ä¿®å¤å**:
1. ç™»å½•æˆåŠŸ
2. Headerå³ä¸Šè§’æ˜¾ç¤ºåŠ è½½éª¨æ¶å± `[=====]`
3. â±ï¸ 200msååŠ è½½å®Œæˆ
4. ğŸ“Š æ˜¾ç¤º"â­ 10000"ï¼ˆç”¨æˆ·çš„å®é™…ç§¯åˆ†ï¼‰
5. ğŸ˜Š ç”¨æˆ·çœ‹åˆ°è‡ªå·±çš„è´¦æˆ·ä½™é¢

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### ä¿®å¤åŸç†

#### ä¿®å¤1: åŠ è½½çŠ¶æ€å®Œæ•´æ€§
```
æ‰€æœ‰æ‰§è¡Œè·¯å¾„éƒ½å¿…é¡»è®¾ç½®åŠ è½½çŠ¶æ€:
âœ… åˆå§‹åŒ–æ—¶ -> è®¾ç½®loading=false
âœ… æˆåŠŸè·å– -> è®¾ç½®loading=false
âœ… APIé”™è¯¯ -> è®¾ç½®loading=false
âœ… è®¤è¯å¤±è´¥ -> è®¾ç½®loading=false
```

#### ä¿®å¤2: æ•°æ®éªŒè¯
```
JavaScriptåŠ¨æ€ç±»å‹çš„é™·é˜±:
âŒ const credits = data as UserCredits;  // ç±»å‹æ–­è¨€ä¸éªŒè¯
âœ… if (typeof credits.available !== 'number') throw Error;  // è¿è¡Œæ—¶éªŒè¯
```

#### ä¿®å¤3: é”™è¯¯æ¸…æ™°æ€§
```
äººæœºäº¤äº’è®¾è®¡åŸåˆ™:
âŒ "-" â†’ ç”¨æˆ·ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ
âœ… "âš ï¸" + titleæç¤º â†’ ç”¨æˆ·çŸ¥é“éœ€è¦åˆ·æ–°
```

---

## ğŸ”„ é•¿æœŸæ”¹è¿›å»ºè®®

1. **ç›‘æ§**: æ·»åŠ é”™è¯¯æ—¥å¿—ï¼Œç›‘æ§APIè°ƒç”¨å¤±è´¥ç‡
2. **é‡è¯•**: è€ƒè™‘æ·»åŠ è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
3. **ç¼“å­˜**: è€ƒè™‘æ·»åŠ æœ¬åœ°ç¼“å­˜ï¼Œå‡å°‘APIè°ƒç”¨
4. **ä¼˜åŒ–**: è€ƒè™‘ä»30ç§’æ”¹ä¸ºç”¨æˆ·æ“ä½œæ—¶çš„æŒ‰éœ€åˆ·æ–°

---

## âœ¨ æ€»ç»“

è¿™æ¬¡ä¿®å¤ä½“ç°äº†**ä¸‰å±‚é—®é¢˜åˆ†ææ–¹æ³•**:

1. **ç°è±¡å±‚** ğŸ“± - ç”¨æˆ·çœ‹ä¸åˆ°ç§¯åˆ†
2. **æœ¬è´¨å±‚** ğŸ”§ - ä»£ç ä¸­çš„ä¸‰ä¸ªå…·ä½“é—®é¢˜
3. **å“²å­¦å±‚** ğŸ’¡ - éµå¾ª"å¥½å“å‘³"çš„ä»£ç è®¾è®¡åŸåˆ™

**ä¿®å¤æˆæœ**:
- âœ… ç”¨æˆ·èƒ½çœ‹åˆ°ä»–ä»¬çš„è´¦æˆ·ä½™é¢
- âœ… åŠ è½½çŠ¶æ€ä¸ä¼šæ°¸ä¹…å¡ä½
- âœ… é”™è¯¯æ—¶æœ‰æ¸…æ™°çš„è§†è§‰åé¦ˆ
- âœ… ä»£ç è´¨é‡æå‡

**ä¸‹ä¸€æ­¥**:
- ğŸ“¤ å‡†å¤‡åˆå¹¶åˆ°ä¸»åˆ†æ”¯
- ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
- ğŸ“Š ç›‘æ§ç”¨æˆ·åé¦ˆ

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-12-27
**éªŒè¯çŠ¶æ€**: âœ… å®Œå…¨é€šè¿‡
**å¯éƒ¨ç½²çŠ¶æ€**: âœ… å·²å°±ç»ª
