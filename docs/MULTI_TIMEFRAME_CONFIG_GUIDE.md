# 多时间框架配置指南

本指南介绍如何配置和使用 NOFX 的多时间框架功能。

---

## 📋 目录

- [功能概述](#功能概述)
- [快速开始](#快速开始)
- [配置说明](#配置说明)
- [支持的时间框架](#支持的时间框架)
- [配置示例](#配置示例)
- [最佳实践](#最佳实践)
- [常见问题](#常见问题)

---

## 功能概述

多时间框架功能允许您同时监控和分析多个时间周期的市场数据，从而做出更全面的交易决策。

### 核心特性

✅ **灵活配置**: 支持 1-11 个时间框架的任意组合  
✅ **热重载**: 配置更新无需重启，立即生效  
✅ **并发优化**: 多个时间框架并发获取，性能优异  
✅ **向后兼容**: 完全兼容旧版配置  
✅ **AI 集成**: 自动将多时间框架数据传递给 AI 决策引擎

---

## 快速开始

### 1. 基础配置

在 Trader 配置中添加 `indicator_config` 字段：

```json
{
  "trader_id": "my-trader-001",
  "symbol": "BTCUSDT",
  "side": "long",
  "indicator_config": {
    "timeframes": ["3m", "1h", "4h"],
    "indicators": ["ema", "macd", "rsi"],
    "data_points": {
      "3m": 40,
      "1h": 30,
      "4h": 25
    }
  }
}
```

### 2. 启动 Trader

配置会自动加载，AI 将收到包含 3m、1h、4h 三个时间框架的完整数据。

### 3. 热重载配置

通过 API 更新配置，立即生效：

```bash
curl -X POST http://localhost:8080/api/traders/my-trader-001/reload-config \
  -H "Content-Type: application/json" \
  -d '{
    "timeframes": ["3m", "15m", "1h", "4h"],
    "data_points": {
      "3m": 40,
      "15m": 35,
      "1h": 30,
      "4h": 25
    }
  }'
```

---

## 配置说明

### IndicatorConfig 结构

```go
type IndicatorConfig struct {
    Indicators []string          `json:"indicators"`  // 启用的指标
    Timeframes []string          `json:"timeframes"`  // 时间框架列表
    DataPoints map[string]int    `json:"data_points"` // 每个时间框架的数据点数
    Parameters map[string]int    `json:"parameters"`  // 指标参数（可选）
}
```

### 字段说明

#### `timeframes` (必填)

时间框架列表，决定 AI 将分析哪些时间周期的数据。

- **类型**: `[]string`
- **示例**: `["3m", "1h", "4h"]`
- **限制**: 1-11 个时间框架

#### `indicators` (必填)

启用的技术指标列表。

- **类型**: `[]string`
- **可选值**: `["ema", "macd", "rsi", "atr", "volume", "bollinger"]`
- **推荐**: `["ema", "macd", "rsi"]`（核心指标）

#### `data_points` (必填)

每个时间框架的 K 线数据点数量。

- **类型**: `map[string]int`
- **示例**: `{"3m": 40, "1h": 30}`
- **说明**: 数据点越多，历史数据越丰富，但计算时间也会增加

#### `parameters` (可选)

指标计算参数。

- **类型**: `map[string]int`
- **默认值**: 
  ```json
  {
    "rsi_period": 14,
    "ema_period": 20,
    "macd_fast": 12,
    "macd_slow": 26,
    "macd_signal": 9
  }
  ```

---

## 支持的时间框架

### 完整列表

| 时间框架 | 代码 | 说明 | 推荐数据点 |
|---------|------|------|-----------|
| 1分钟 | `1m` | 超短线 | 60-100 |
| 3分钟 | `3m` | 短线 | 40-60 |
| 5分钟 | `5m` | 短线 | 30-50 |
| 15分钟 | `15m` | 短线 | 20-40 |
| 30分钟 | `30m` | 中短线 | 20-35 |
| 1小时 | `1h` | 中线 | 24-30 |
| 2小时 | `2h` | 中线 | 20-28 |
| 4小时 | `4h` | 中长线 | 20-25 |
| 6小时 | `6h` | 长线 | 15-25 |
| 12小时 | `12h` | 长线 | 14-20 |
| 1天 | `1d` | 超长线 | 14-30 |

### 时间框架分类

#### 短线策略
```json
{
  "timeframes": ["1m", "3m", "5m"]
}
```
- 适用场景: 高频交易、快进快出
- 优点: 反应迅速
- 缺点: 噪音较多

#### 中线策略
```json
{
  "timeframes": ["15m", "1h", "4h"]
}
```
- 适用场景: 日内交易、波段交易
- 优点: 平衡性好
- 缺点: 需要更多耐心

#### 长线策略
```json
{
  "timeframes": ["4h", "1d"]
}
```
- 适用场景: 趋势跟踪、长期持仓
- 优点: 信号可靠
- 缺点: 反应较慢

#### 多周期综合策略 ⭐ 推荐
```json
{
  "timeframes": ["3m", "1h", "4h"]
}
```
- 适用场景: 综合分析、全面决策
- 优点: 短中长兼顾
- 缺点: 计算量稍大

---

## 配置示例

### 示例 1: 默认配置（推荐新手）

```json
{
  "indicator_config": {
    "timeframes": ["3m", "4h"],
    "indicators": ["ema", "macd", "rsi"],
    "data_points": {
      "3m": 40,
      "4h": 25
    }
  }
}
```

**说明**:
- 2 个时间框架：短线(3m) + 长线(4h)
- 3 个核心指标
- 数据点适中，性能良好

### 示例 2: 三时间框架策略（推荐）

```json
{
  "indicator_config": {
    "timeframes": ["3m", "1h", "4h"],
    "indicators": ["ema", "macd", "rsi", "atr"],
    "data_points": {
      "3m": 40,
      "1h": 30,
      "4h": 25
    }
  }
}
```

**说明**:
- 3 个时间框架：短(3m) + 中(1h) + 长(4h)
- 4 个指标，包含波动率(ATR)
- 最佳平衡性

### 示例 3: 高频交易配置

```json
{
  "indicator_config": {
    "timeframes": ["1m", "3m", "5m"],
    "indicators": ["ema", "rsi", "volume"],
    "data_points": {
      "1m": 100,
      "3m": 60,
      "5m": 40
    }
  }
}
```

**说明**:
- 3 个短线时间框架
- 关注成交量指标
- 数据点较多，提供更多历史参考

### 示例 4: 全周期分析配置

```json
{
  "indicator_config": {
    "timeframes": ["1m", "3m", "15m", "1h", "4h"],
    "indicators": ["ema", "macd", "rsi", "atr", "volume", "bollinger"],
    "data_points": {
      "1m": 60,
      "3m": 40,
      "15m": 35,
      "1h": 30,
      "4h": 25
    },
    "parameters": {
      "rsi_period": 14,
      "ema_period": 20
    }
  }
}
```

**说明**:
- 5 个时间框架，覆盖短中长周期
- 6 个指标，全面分析
- 适合专业交易者

### 示例 5: 趋势跟踪配置

```json
{
  "indicator_config": {
    "timeframes": ["1h", "4h", "1d"],
    "indicators": ["ema", "macd", "bollinger"],
    "data_points": {
      "1h": 30,
      "4h": 25,
      "1d": 20
    }
  }
}
```

**说明**:
- 3 个中长线时间框架
- 关注趋势指标(EMA, MACD, Bollinger)
- 适合趋势跟踪策略

---

## 最佳实践

### 1. 时间框架选择

#### 原则 1: 不要太多
- ❌ 避免: 配置 8+ 个时间框架
- ✅ 推荐: 2-5 个时间框架
- 原因: 太多时间框架会增加噪音，降低决策效率

#### 原则 2: 覆盖不同周期
- ❌ 避免: `["1m", "3m", "5m"]`（过于接近）
- ✅ 推荐: `["3m", "1h", "4h"]`（短中长兼顾）
- 原因: 不同周期提供互补信息

#### 原则 3: 根据策略调整
- 日内交易: `["3m", "15m", "1h"]`
- 波段交易: `["1h", "4h", "1d"]`
- 高频交易: `["1m", "3m", "5m"]`

### 2. 数据点配置

#### 推荐数据点范围

| 时间框架 | 最小值 | 推荐值 | 最大值 |
|---------|-------|--------|--------|
| 1m | 30 | 60-100 | 200 |
| 3m | 20 | 40-60 | 120 |
| 5m | 20 | 30-50 | 100 |
| 15m | 15 | 20-40 | 80 |
| 30m | 15 | 20-35 | 70 |
| 1h | 12 | 24-30 | 60 |
| 4h | 10 | 20-25 | 50 |
| 1d | 7 | 14-30 | 60 |

#### 原则
- **历史覆盖**: 确保有足够历史数据计算指标
  - RSI: 至少 14 个数据点
  - EMA20: 至少 20 个数据点
  - MACD: 至少 34 个数据点

- **性能考虑**: 数据点越多，计算时间越长
  - 3 个时间框架 × 40 数据点 ≈ 200ms
  - 5 个时间框架 × 60 数据点 ≈ 400ms

### 3. 指标选择

#### 核心指标（必选）
```json
{
  "indicators": ["ema", "macd", "rsi"]
}
```

#### 增强指标（可选）
```json
{
  "indicators": ["ema", "macd", "rsi", "atr", "volume", "bollinger"]
}
```

#### 指标说明
- **EMA**: 趋势方向
- **MACD**: 动量和趋势变化
- **RSI**: 超买超卖
- **ATR**: 波动率
- **Volume**: 成交量确认
- **Bollinger**: 价格区间

### 4. 热重载使用

#### 何时使用热重载

✅ **适合场景**:
- 调整时间框架组合
- 修改数据点数量
- 切换交易策略
- A/B 测试不同配置

❌ **不适合场景**:
- 频繁修改（< 5分钟）
- 生产环境频繁调整
- 关键交易时段

#### 热重载最佳实践

1. **先在测试环境验证**
   ```bash
   # 测试环境
   curl -X POST http://test-server:8080/api/traders/test-001/reload-config ...
   ```

2. **监控重载后的表现**
   - 检查日志
   - 观察 AI 决策
   - 验证提示词生成

3. **保留配置历史**
   ```bash
   # 备份当前配置
   cp config.json config.backup.$(date +%Y%m%d_%H%M%S).json
   ```

### 5. 性能优化

#### 优化建议

1. **减少时间框架数量**
   - 3-4 个时间框架最佳
   - 避免超过 6 个

2. **合理设置数据点**
   - 短线时间框架: 30-60
   - 长线时间框架: 20-30

3. **使用默认参数**
   - 除非有特殊需求，使用默认指标参数

4. **监控性能指标**
   ```bash
   # 查看获取市场数据耗时
   grep "市场数据获取" logs/trader.log
   ```

---

## 常见问题

### Q1: 最多支持多少个时间框架？

**A**: 系统支持 11 个时间框架同时使用，但推荐 2-5 个以获得最佳性能和决策质量。

### Q2: 热重载会影响当前持仓吗？

**A**: 不会。热重载只更新市场数据获取配置，不影响已有持仓。下次 AI 决策时会使用新配置的时间框架数据。

### Q3: 如何知道配置是否生效？

**A**: 检查以下内容：
1. API 响应返回成功
2. 查看日志：`grep "配置已更新" logs/trader.log`
3. 下次 AI 决策的提示词包含新时间框架

### Q4: 不同时间框架的数据点数量必须一样吗？

**A**: 不必须。推荐根据时间框架特点设置：
- 短线时间框架（1m, 3m）: 更多数据点（40-100）
- 长线时间框架（4h, 1d）: 较少数据点（20-30）

### Q5: 配置错误会怎样？

**A**: 系统会：
1. 验证时间框架是否支持（1m-1d）
2. 忽略不支持的时间框架
3. 记录警告日志
4. 使用有效的时间框架继续运行

### Q6: 如何回退到旧配置？

**A**: 
```bash
# 使用备份配置重新加载
curl -X POST http://localhost:8080/api/traders/my-trader-001/reload-config \
  -H "Content-Type: application/json" \
  -d @config.backup.json
```

### Q7: 可以不配置 `indicator_config` 吗？

**A**: 可以。系统会使用默认配置：
```json
{
  "timeframes": ["3m", "4h"],
  "indicators": ["ema", "macd", "rsi", "atr", "volume"],
  "data_points": {
    "3m": 40,
    "4h": 25
  }
}
```

### Q8: 多个 Trader 可以使用不同配置吗？

**A**: 可以。每个 Trader 有独立的 `indicator_config`，互不影响。

### Q9: 配置更新后多久生效？

**A**: 立即生效。下一次调用 `market.Get()` 就会使用新配置。

### Q10: 如何验证多时间框架数据？

**A**: 查看 AI 决策日志，提示词中会显示所有时间框架：
```
Time series data (3-minute timeframe, oldest → latest):
...
Time series data (1-hour timeframe, oldest → latest):
...
Time series data (4-hour timeframe, oldest → latest):
...
```

---

## 下一步

- 📖 阅读 [API 文档](./API_DOCUMENTATION.md)
- 📖 阅读 [迁移指南](./MIGRATION_GUIDE.md)
- 🔧 查看 [配置示例文件](../config.example.json)
- 🚀 开始使用多时间框架功能！

---

**版本**: v2.0.0  
**更新日期**: 2025-11-12
