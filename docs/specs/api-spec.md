# NOFX HTTP API Specification (Current Implementation)

This document describes the HTTP/JSON API surface of the NOFX backend as implemented in `api/server.go` and consumed by the React frontend (`web/src/lib/api.ts`). It is intended to be a precise contract for backend–frontend interaction.

All paths are rooted at `/api` unless explicitly stated otherwise.

## 1. Common Conventions

- **Base URL:** `/api`
- **Content type:** `application/json` for request and response bodies unless otherwise specified.
- **Authentication:** JWT via header `Authorization: Bearer <token>`.
- **Errors:** On error, endpoints return a non-2xx status code with a JSON body:
  ```jsonc
  {
    "error": "human readable message"
  }
  ```
- **Trader selection:** Many endpoints accept `?trader_id=<id>`; when omitted, backend selects a default trader for the authenticated user (typically their first trader).

## 2. Health & System Config

### 2.1 Health Check

- **Method/Path:** `ANY /health`
- **Auth:** None.
- **Request:** No body.
- **Response:**
  ```json
  {
    "status": "ok",
    "time": "<server time or context value>"
  }
  ```

### 2.2 System Config

- **Method/Path:** `GET /config`
- **Auth:** None.
- **Purpose:** Returns client-visible system configuration and flags.
- **Response:**
  ```json
  {
    "beta_mode": true,
    "default_coins": ["BTCUSDT", "ETHUSDT", "..."],
    "btc_eth_leverage": 5,
    "altcoin_leverage": 5,
    "registration_enabled": true
  }
  ```

## 3. Authentication

Exact payload fields are defined in `api/server.go` auth handlers; below are the logical contracts used by the frontend.

### 3.1 Register

- **Method/Path:** `POST /register`
- **Auth:** None.
- **Request:**
  ```jsonc
  {
    "email": "user@example.com",
    "password": "string",
    // additional fields like beta code depending on current flow
    "beta_code": "optional"
  }
  ```
- **Response (success):**
  ```json
  {
    "status": "pending",
    "user_id": "uuid-or-similar"
  }
  ```

### 3.2 Login

- **Method/Path:** `POST /login`
- **Auth:** None.
- **Request:**
  ```json
  {
    "email": "user@example.com",
    "password": "string",
    "totp_code": "optional"
  }
  ```
- **Response (success):**
  ```json
  {
    "token": "jwt-token",
    "user": {
      "id": "user-id",
      "email": "user@example.com"
    }
  }
  ```

### 3.3 Verify OTP

- **Method/Path:** `POST /verify-otp`
- **Auth:** None.
- **Request:**
  ```json
  {
    "email": "user@example.com",
    "otp_code": "123456"
  }
  ```
- **Response:** Confirms OTP verification; exact structure defined in handler.

### 3.4 Complete Registration

- **Method/Path:** `POST /complete-registration`
- **Auth:** None.
- **Request:** Data required to complete account (e.g. email + OTP + password).
- **Response:** Final user object or status.

### 3.5 Logout

- **Method/Path:** `POST /logout`
- **Auth:** Required.
- **Request:** No body.
- **Response:**
  ```json
  {
    "status": "ok"
  }
  ```

## 4. Cryptography Utilities

### 4.1 Get Public Key

- **Method/Path:** `GET /crypto/public-key`
- **Auth:** None.
- **Response:**
  ```json
  {
    "public_key": "PEM-encoded-RSA-public-key"
  }
  ```

### 4.2 Decrypt Sensitive Data

- **Method/Path:** `POST /crypto/decrypt`
- **Auth:** None (payload already encrypted and tied to user/session).
- **Request:** Encrypted payload as generated by frontend `CryptoService.encryptSensitiveData`.
- **Response:** Decrypted JSON object; used internally by protected endpoints (e.g. models/exchanges) when `Content-Type` indicates encrypted payload.

## 5. Models & Exchanges

### 5.1 Supported Models

- **Method/Path:** `GET /supported-models`
- **Auth:** None.
- **Response:**
  ```json
  [
    { "id": "deepseek", "name": "DeepSeek", "provider": "deepseek" },
    { "id": "qwen", "name": "Qwen", "provider": "qwen" }
  ]
  ```

### 5.2 Supported Exchanges

- **Method/Path:** `GET /supported-exchanges`
- **Auth:** None.
- **Response:**
  ```json
  [
    { "id": "binance", "name": "Binance Futures", "type": "binance" },
    { "id": "hyperliquid", "name": "Hyperliquid", "type": "hyperliquid" },
    { "id": "aster", "name": "Aster DEX", "type": "aster" }
  ]
  ```

### 5.3 Get Model Configs

- **Method/Path:** `GET /models`
- **Auth:** Required.
- **Response:**
  ```json
  [
    {
      "id": "deepseek",
      "name": "DeepSeek",
      "provider": "deepseek",
      "enabled": true,
      "api_key": "masked-or-empty",
      "custom_api_url": "",
      "custom_model_name": ""
    }
  ]
  ```

### 5.4 Update Model Configs

- **Method/Path:** `PUT /models`
- **Auth:** Required.
- **Request:** Either plaintext or encrypted:
  ```jsonc
  {
    "models": [
      {
        "id": "deepseek",
        "enabled": true,
        "api_key": "secret",
        "custom_api_url": "https://..",
        "custom_model_name": "my-model-name"
      }
    ]
  }
  ```
- **Response:** Status or updated list (depending on handler implementation).

### 5.5 Get Exchange Configs

- **Method/Path:** `GET /exchanges`
- **Auth:** Required.
- **Response:**
  ```json
  [
    {
      "id": "binance",
      "name": "Binance Futures",
      "type": "binance",
      "enabled": true,
      "api_key": "masked-or-empty",
      "secret_key": "",
      "testnet": true,
      "hyperliquid_wallet_addr": "",
      "aster_user": "",
      "aster_signer": "",
      "aster_private_key": ""
    }
  ]
  ```

### 5.6 Update Exchange Configs

- **Method/Path:** `PUT /exchanges`
- **Auth:** Required.
- **Request:** Either plaintext or encrypted:
  ```jsonc
  {
    "exchanges": [
      {
        "id": "binance",
        "enabled": true,
        "api_key": "secret",
        "secret_key": "secret",
        "testnet": true,
        "hyperliquid_wallet_addr": "",
        "aster_user": "",
        "aster_signer": "",
        "aster_private_key": ""
      }
    ]
  }
  ```
- **Response:** Status or updated list.

## 6. User Signal Sources

### 6.1 Get User Signal Sources

- **Method/Path:** `GET /user/signal-sources`
- **Auth:** Required.
- **Response:**
  ```json
  {
    "coin_pool_url": "https://example.com/coin-pool",
    "oi_top_url": "https://example.com/oi-top"
  }
  ```

### 6.2 Save User Signal Sources

- **Method/Path:** `POST /user/signal-sources`
- **Auth:** Required.
- **Request:**
  ```json
  {
    "coin_pool_url": "https://example.com/coin-pool",
    "oi_top_url": "https://example.com/oi-top"
  }
  ```
- **Response:** Status / updated config.

## 7. Trader Management

### 7.1 List My Traders

- **Method/Path:** `GET /my-traders`
- **Auth:** Required.
- **Response:**
  ```json
  [
    {
      "trader_id": "uuid",
      "name": "DeepSeek-Binance-1",
      "ai_model": "deepseek",
      "exchange": "binance",
      "initial_balance": 1000.0,
      "current_equity": 1020.5,
      "status": "running",  // or "stopped"
      "scan_interval_minutes": 3
    }
  ]
  ```

### 7.2 Create Trader

- **Method/Path:** `POST /traders`
- **Auth:** Required.
- **Request (CreateTraderRequest):**
  ```jsonc
  {
    "name": "DeepSeek-Binance-1",
    "ai_model_id": "deepseek",
    "exchange_id": "binance",
    "initial_balance": 1000,
    "btc_eth_leverage": 5,
    "altcoin_leverage": 5,
    "trading_symbols": ["BTCUSDT","ETHUSDT"],
    "use_coin_pool": false,
    "use_oi_top": false,
    "scan_interval_minutes": 3,
    "system_prompt_template": "default"
  }
  ```
- **Response (TraderInfo):**
  ```json
  {
    "trader_id": "uuid",
    "name": "DeepSeek-Binance-1",
    "ai_model": "deepseek",
    "exchange": "binance",
    "initial_balance": 1000.0,
    "status": "stopped"
  }
  ```

### 7.3 Update Trader

- **Method/Path:** `PUT /traders/:id`
- **Auth:** Required.
- **Request:** Same structure as create; must include all fields that should be updated.
- **Response:** Updated `TraderInfo`.

### 7.4 Delete Trader

- **Method/Path:** `DELETE /traders/:id`
- **Auth:** Required.
- **Request:** No body.
- **Response:**
  ```json
  { "status": "deleted" }
  ```

### 7.5 Start Trader

- **Method/Path:** `POST /traders/:id/start`
- **Auth:** Required.
- **Request:** No body.
- **Response:**
  ```json
  { "status": "started" }
  ```

### 7.6 Stop Trader

- **Method/Path:** `POST /traders/:id/stop`
- **Auth:** Required.
- **Request:** No body.
- **Response:**
  ```json
  { "status": "stopped" }
  ```

### 7.7 Get Trader Config

- **Method/Path:** `GET /traders/:id/config`
- **Auth:** Required.
- **Response:** Full trader configuration including risk parameters and trading symbols:
  ```json
  {
    "id": "uuid",
    "name": "DeepSeek-Binance-1",
    "ai_model_id": "deepseek",
    "exchange_id": "binance",
    "initial_balance": 1000.0,
    "btc_eth_leverage": 5,
    "altcoin_leverage": 5,
    "trading_symbols": ["BTCUSDT","ETHUSDT"],
    "use_coin_pool": false,
    "use_oi_top": false,
    "scan_interval_minutes": 3,
    "system_prompt_template": "default",
    "custom_prompt": "",
    "override_base_prompt": false
  }
  ```

### 7.8 Update Trader Prompt

- **Method/Path:** `PUT /traders/:id/prompt`
- **Auth:** Required.
- **Request:**
  ```json
  {
    "custom_prompt": "# My strategy...",
    "override_base": false
  }
  ```
- **Response:** Updated prompt state or generic status.

## 8. Status, Account, Positions, Decisions

All endpoints in this section require authentication and support an optional query parameter `trader_id`.

### 8.1 Status

- **Method/Path:** `GET /status`
- **Auth:** Required.
- **Query:**
  - `trader_id` (optional).
- **Response (SystemStatus):**
  ```json
  {
    "trader_id": "uuid",
    "name": "DeepSeek-Binance-1",
    "ai_model": "deepseek",
    "exchange": "binance",
    "is_running": true,
    "last_decision_time": "2025-11-17T12:34:56Z",
    "scan_interval_minutes": 3
  }
  ```

### 8.2 Account

- **Method/Path:** `GET /account`
- **Auth:** Required.
- **Query:** `trader_id` optional.
- **Response (AccountInfo):**
  ```json
  {
    "total_equity": 1020.5,
    "available_balance": 900.0,
    "unrealized_pnl": 20.5,
    "total_pnl": 20.5,
    "total_pnl_pct": 2.05,
    "margin_used": 120.5,
    "margin_used_pct": 12.0,
    "position_count": 2
  }
  ```

### 8.3 Positions

- **Method/Path:** `GET /positions`
- **Auth:** Required.
- **Query:** `trader_id` optional.
- **Response (array of Position):**
  ```json
  [
    {
      "symbol": "BTCUSDT",
      "side": "long",
      "entry_price": 95000,
      "mark_price": 96000,
      "quantity": 0.1,
      "leverage": 5,
      "unrealized_pnl": 100.0,
      "unrealized_pnl_pct": 10.5,
      "peak_pnl_pct": 15.0,
      "liquidation_price": 90000,
      "margin_used": 200.0,
      "update_time": 1700000000000
    }
  ]
  ```

### 8.4 Decisions

- **Method/Path:** `GET /decisions`
- **Auth:** Required.
- **Query:** `trader_id` optional, plus paging parameters if implemented.
- **Response (array of DecisionRecord):**
  ```json
  [
    {
      "id": "uuid",
      "timestamp": "2025-11-17T12:34:56Z",
      "symbol": "BTCUSDT",
      "action": "open_long",
      "leverage": 5,
      "position_size_usd": 500,
      "stop_loss": 93000,
      "take_profit": 99000,
      "confidence": 85,
      "risk_usd": 150,
      "reasoning": "analysis text..."
    }
  ]
  ```

### 8.5 Latest Decisions

- **Method/Path:** `GET /decisions/latest`
- **Auth:** Required.
- **Query:**
  - `trader_id` (optional).
  - `limit` (optional, default 5).
- **Response:** Same shape as `/decisions`, truncated by `limit`.

### 8.6 Statistics

- **Method/Path:** `GET /statistics`
- **Auth:** Required.
- **Query:** `trader_id` optional.
- **Response (Statistics):**
  ```json
  {
    "win_rate": 0.6,
    "avg_win": 30.0,
    "avg_loss": -15.0,
    "max_drawdown": -25.0,
    "trade_count": 120
  }
  ```

### 8.7 Performance (AI Learning)

- **Method/Path:** `GET /performance`
- **Auth:** Required.
- **Query:** `trader_id` optional.
- **Response:** High-level AI learning summary (see logger implementation for exact fields).

## 9. Equity History & Competition

### 9.1 Equity History

- **Method/Path:** `GET /equity-history`
- **Auth:** Required for per-user data; public for generic competition view.
- **Query:** `trader_id` optional.
- **Response:**
  ```json
  [
    {
      "timestamp": "2025-11-17T12:00:00Z",
      "equity": 1000.0,
      "pnl_pct": 0.0
    }
  ]
  ```

### 9.2 Equity History Batch

- **Method/Path:** `POST /equity-history-batch`
- **Auth:** None (competition use).
- **Request:**
  ```json
  {
    "trader_ids": ["id1","id2","id3"]
  }
  ```
- **Response:**
  ```json
  {
    "id1": [ /* equity history */ ],
    "id2": [ /* equity history */ ]
  }
  ```

### 9.3 Top Traders

- **Method/Path:** `GET /top-traders`
- **Auth:** None.
- **Response:**
  ```json
  [
    {
      "trader_id": "id1",
      "trader_name": "DeepSeek-Binance-1",
      "ai_model": "deepseek",
      "exchange": "binance",
      "total_equity": 1200.0,
      "total_pnl": 200.0,
      "total_pnl_pct": 20.0
    }
  ]
  ```

### 9.4 Competition

- **Method/Path:** `GET /competition`
- **Auth:** None.
- **Response (CompetitionData):**
  ```json
  {
    "traders": [
      {
        "trader_id": "id1",
        "trader_name": "DeepSeek-Binance-1",
        "ai_model": "deepseek",
        "exchange": "binance",
        "total_equity": 1200.0,
        "total_pnl": 200.0,
        "total_pnl_pct": 20.0,
        "position_count": 1,
        "margin_used_pct": 10.0,
        "is_running": true,
        "system_prompt_template": "default"
      }
    ],
    "count": 1,
    "total_count": 10
  }
  ```

### 9.5 Public Trader List

- **Method/Path:** `GET /traders`
- **Auth:** None.
- **Response:** Simplified `TraderInfo` list for public display (similar to `/competition` rows).

### 9.6 Public Trader Config

- **Method/Path:** `GET /traders/:id/public-config`
- **Auth:** None.
- **Response:** Public-safe subset of config for the given trader:
  ```json
  {
    "trader_id": "id1",
    "name": "DeepSeek-Binance-1",
    "ai_model": "deepseek",
    "exchange": "binance",
    "initial_balance": 1000.0
  }
  ```

## 10. Server IP Utility

### 10.1 Get Server IP

- **Method/Path:** `GET /server-ip`
- **Auth:** Required.
- **Response:**
  ```json
  {
    "public_ip": "198.51.100.10",
    "message": "请将此IP地址添加到白名单中"
  }
  ```

## 11. Prompt Templates

### 11.1 List Prompt Templates

- **Method/Path:** `GET /prompt-templates`
- **Auth:** None.
- **Response:** List of available prompt templates, including `name` and metadata.

### 11.2 Get Prompt Template

- **Method/Path:** `GET /prompt-templates/:name`
- **Auth:** None.
- **Response:** Template content and description:
  ```json
  {
    "name": "default",
    "content": "long markdown prompt..."
  }
  ```

## 12. Notes and Divergences

- This spec is intentionally focused on currently implemented endpoints in `api/server.go` and their usage via `web/src/lib/api.ts`.
- For any future endpoints:
  - Add them to this document as a single source of truth.
  - Update frontend `api.ts` accordingly.
  - Keep naming consistent (`/traders/:id/...` vs `/trader/:id/...`) to avoid confusion.
