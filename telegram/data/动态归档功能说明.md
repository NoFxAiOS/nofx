# 🎯 动态归档功能说明

## ✨ 核心特性

**无需重启，手机端实时控制！**

现在你可以：
1. 📱 在手机 Telegram 上归档频道 → 程序自动开始监听
2. 📱 在手机上取消归档 → 程序自动停止监听该频道
3. ⏰ 全程自动，最多延迟 5 分钟生效

---

## 🚀 快速使用

### 1. 开启动态归档模式

编辑 `.env` 文件：

```bash
# 开启自动监听
LISTEN_ALL_SUBSCRIBED_CHANNELS=true

# 🔑 只监听归档频道
LISTEN_ARCHIVED_ONLY=true

# ⏰ 归档状态刷新间隔（秒）默认 300 秒 = 5 分钟
ARCHIVED_REFRESH_INTERVAL=300

# 留空（不使用白名单）
CHANNEL_ALLOWLIST=
```

### 2. 启动程序

```bash
./start.sh
```

你会看到：

```
📂 归档频道列表:
 1. 华尔街见闻 (@wallstreetcn) 📂
 2. 金十数据 (@jin10com) 📂
 ...

归档频道动态跟踪已启动（刷新间隔: 300 秒）
📱 手机端归档/取消归档频道会自动生效，无需重启程序
系统就绪，等待新消息...
```

### 3. 在手机上操作

#### 🆕 添加新频道到监听列表

1. 在 Telegram 找到想监听的频道
2. **归档该频道**（Archive）
3. 等待最多 5 分钟（或配置的刷新间隔）
4. 程序会自动检测并开始监听

**日志输出示例**：
```
📂 检测到新归档频道 (1 个):
  ➕ 彭博社 (@bloomberg)
📂 新归档频道: 彭博社 (@bloomberg)
```

#### ❌ 停止监听某个频道

1. 在 Telegram 找到不想监听的频道
2. **取消归档**（Unarchive）
3. 等待最多 5 分钟
4. 程序自动停止监听该频道

**日志输出示例**：
```
📋 检测到取消归档频道 (1 个):
  ➖ 路透社 (@reuters)
📋 取消归档: 路透社 (@reuters)
```

---

## ⚙️ 配置说明

### ARCHIVED_REFRESH_INTERVAL（刷新间隔）

| 值（秒） | 延迟 | 推荐场景 |
|---------|-----|---------|
| `60` | ~1 分钟 | 快速响应（频繁调整） |
| `300` | ~5 分钟 | 默认推荐（平衡性能） |
| `600` | ~10 分钟 | 低频调整（节省资源） |
| `1800` | ~30 分钟 | 极少调整 |

**注意**：
- 值越小，响应越快，但会更频繁查询 Telegram API
- 建议保持默认 `300` 秒（5 分钟）

---

## 🔍 工作原理

### 架构图

```
┌─────────────────────────────────────────────────────────┐
│                  用户手机端操作                           │
│         归档/取消归档频道 (Telegram App)                  │
└────────────────────┬────────────────────────────────────┘
                     ↓
         Telegram 云端更新 folder_id
                     ↓
┌─────────────────────────────────────────────────────────┐
│              程序定时检测任务                              │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 每隔 N 秒运行: archived_refresh_loop()           │  │
│  │ 1. 调用 get_dialogs(folder=1)                    │  │
│  │ 2. 获取最新归档频道列表                          │  │
│  │ 3. 与缓存对比 (archived_channel_ids)             │  │
│  │ 4. 检测新增/移除的频道                           │  │
│  │ 5. 记录日志并打印通知                            │  │
│  │ 6. 更新缓存                                       │  │
│  └──────────────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────────┐
│           消息处理器 (message_handler)                    │
│  ┌──────────────────────────────────────────────────┐  │
│  │ 每条新消息到达时:                                 │  │
│  │ 1. 提取频道ID                                     │  │
│  │ 2. 检查是否在 archived_channel_ids 中             │  │
│  │ 3. 在列表中 → 处理消息                            │  │
│  │ 4. 不在列表中 → 跳过消息                          │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 核心组件

#### 1. **归档频道缓存** (`archived_channel_ids`)

```python
# jt_bot.py:788-790
self.archived_channel_ids: set[int] = set()  # 当前归档频道ID集合
self.last_archived_refresh = 0.0             # 上次刷新时间
self.archived_refresh_task: Optional[asyncio.Task] = None
```

#### 2. **定时刷新任务** (`archived_refresh_loop()`)

```python
# jt_bot.py:1317-1336
async def archived_refresh_loop(self):
    # 每隔 N 秒运行
    while self.running:
        await asyncio.sleep(interval)
        await self.refresh_archived_channels()  # 刷新归档列表
```

#### 3. **变化检测** (`refresh_archived_channels()`)

```python
# jt_bot.py:1276-1306
added = new_archived_ids - self.archived_channel_ids    # 新归档的
removed = self.archived_channel_ids - new_archived_ids  # 取消归档的
```

#### 4. **消息过滤** (`message_handler()`)

```python
# jt_bot.py:1067-1078
if config.listen_archived_only:
    if channel_id not in self.archived_channel_ids:
        return  # 跳过非归档频道的消息
```

---

## 📊 实时状态监控

### 查看当前归档频道

程序运行时，归档状态会自动刷新。你可以通过日志查看：

```bash
tail -f logs/jt_bot.log | grep "归档"
```

示例输出：

```
2025-11-02 19:30:22 │ INFO │ 归档频道动态跟踪已启动（刷新间隔: 300 秒）
2025-11-02 19:30:22 │ DEBUG │ 归档频道列表已更新，当前 15 个归档频道
2025-11-02 19:35:22 │ INFO │ 📂 检测到新归档频道 (1 个):
2025-11-02 19:35:22 │ INFO │   ➕ 彭博社 (@bloomberg)
```

---

## 🎬 实际使用场景

### 场景 1: 动态管理财经频道

**初始状态**：监听 10 个归档的财经频道

**操作**：
1. 发现一个新的优质频道 "全球市场快讯"
2. 在手机上归档它
3. 5 分钟后，程序自动开始监听
4. 新频道的消息开始入库

**场景 2: 临时屏蔽低质量频道**

**问题**：某个频道最近发送大量广告

**操作**：
1. 在手机上取消归档该频道
2. 5 分钟后，程序停止监听
3. 广告消息不再入库
4. 后续频道质量恢复后，再次归档即可恢复监听

---

## ⚠️ 注意事项

### 1. 刷新延迟

- 归档/取消归档操作不是立即生效
- 最大延迟 = `ARCHIVED_REFRESH_INTERVAL` 秒
- 默认 5 分钟

### 2. 白名单模式冲突

**配置冲突**：
```bash
LISTEN_ALL_SUBSCRIBED_CHANNELS=false  # ❌ 关闭自动监听
LISTEN_ARCHIVED_ONLY=true             # 🚫 无效（被白名单覆盖）
CHANNEL_ALLOWLIST=频道1,频道2          # ✅ 生效
```

**结论**：使用白名单时，归档模式无效。

### 3. 首次启动

- 首次启动时会立即刷新归档列表
- 不会显示 "新归档频道" 通知（因为是初始化）
- 后续变化才会触发通知

### 4. 性能影响

- 刷新任务非常轻量（每次仅查询 folder=1）
- 默认 5 分钟间隔对服务器压力极小
- 建议不要设置低于 60 秒

---

## 🐛 故障排查

### 问题 1: 归档了频道但程序没反应

**检查清单**：
1. 确认 `LISTEN_ARCHIVED_ONLY=true`
2. 确认 `LISTEN_ALL_SUBSCRIBED_CHANNELS=true`
3. 查看日志中是否有刷新记录：
   ```bash
   grep "归档频道列表已更新" logs/jt_bot.log
   ```
4. 等待至少一个刷新周期（默认 5 分钟）

### 问题 2: 日志中没有 "检测到新归档频道"

**可能原因**：
1. 频道已经在归档列表中（不算新增）
2. 刷新间隔未到
3. 程序未启动归档模式

**解决方法**：
```bash
# 查看是否启动了刷新任务
grep "归档频道动态跟踪已启动" logs/jt_bot.log
```

### 问题 3: 频道ID类型不匹配

**错误日志**：
```
频道不在归档列表中，跳过 | 频道: XXX [ID: -1001234567890]
```

**原因**：频道ID是字符串，需要转换为整数

**已修复**：代码中已处理（jt_bot.py:1073）

---

## 📈 最佳实践

### 1. 合理设置刷新间隔

```bash
# 根据使用频率选择
ARCHIVED_REFRESH_INTERVAL=300  # 频繁调整用 300 秒（5分钟）
ARCHIVED_REFRESH_INTERVAL=600  # 稳定运行用 600 秒（10分钟）
```

### 2. 使用归档作为"工作区"

将 Telegram 归档文件夹作为"监听工作区"：
- 归档 = 监听
- 主界面 = 不监听

这样可以清晰地管理哪些频道正在被采集。

### 3. 配合消息过滤

动态归档 + 黑名单过滤 = 精准控制：

```bash
# 监听所有归档频道，但过滤推广内容
LISTEN_ARCHIVED_ONLY=true
ENABLE_BLACKLIST=true
```

---

## 🔧 高级配置

### 立即刷新归档列表（手动触发）

如果不想等待刷新间隔，重启程序即可立即刷新：

```bash
./start.sh stop
./start.sh
```

首次启动会立即调用 `refresh_archived_channels()`。

### 查看实时刷新日志

```bash
# 实时查看归档变化
tail -f logs/jt_bot.log | grep -E "归档|Archive"
```

---

## 📝 代码变更摘要

### 修改的文件

1. **`.env`** (第 24 行)
   - 新增 `ARCHIVED_REFRESH_INTERVAL=300` 配置项

2. **`telegram_collector/jt_bot.py`**
   - 第 422-425 行: 读取刷新间隔配置
   - 第 787-790 行: 添加归档频道缓存
   - 第 1067-1078 行: 消息处理时检查归档状态
   - 第 1259-1336 行: 实现刷新和定时任务
   - 第 1385-1421 行: 启动/停止刷新任务

### 新增功能

- `refresh_archived_channels()`: 刷新归档列表并检测变化
- `archived_refresh_loop()`: 定时刷新后台任务
- 自动变化检测和日志通知

---

## 🎉 总结

**动态归档功能让你能够：**

✅ 通过手机 Telegram 实时控制监听范围
✅ 无需重启程序即可生效
✅ 自动检测并通知归档变化
✅ 简单直观的频道管理方式

**推荐配置**：

```bash
LISTEN_ALL_SUBSCRIBED_CHANNELS=true
LISTEN_ARCHIVED_ONLY=true
ARCHIVED_REFRESH_INTERVAL=300
```

现在开始，用归档文件夹管理你的监听列表吧！ 📂✨

---

**最后更新**: 2025-11-02
**版本**: v2.0.0 (动态归档)
