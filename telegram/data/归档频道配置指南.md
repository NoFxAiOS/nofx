# 归档频道配置指南

## 快速开始

### 1️⃣ 在 Telegram 中归档频道

1. 打开 Telegram
2. 找到你想监听的频道
3. 右键点击（或长按）→ 选择 "归档"
4. 重复以上步骤，归档所有你想监听的频道

### 2️⃣ 修改配置文件

编辑 `.env` 文件，设置以下配置：

```bash
# 启用自动监听所有订阅频道
LISTEN_ALL_SUBSCRIBED_CHANNELS=true

# 🔑 启用归档过滤（只监听归档的频道）
LISTEN_ARCHIVED_ONLY=true

# 留空（不使用白名单）
CHANNEL_ALLOWLIST=
```

### 3️⃣ 重启程序

```bash
./start.sh stop
./start.sh
```

### 4️⃣ 验证

查看启动日志，应该看到：

```
📂 归档频道列表:
 1. 华尔街见闻 (@wallstreetcn) 📂
 2. 金十数据 (@jin10com) 📂
 ...
```

---

## 配置对照表

| 你想要的效果 | LISTEN_ALL_SUBSCRIBED | LISTEN_ARCHIVED_ONLY | CHANNEL_ALLOWLIST |
|------------|----------------------|---------------------|-------------------|
| **只监听归档频道** | `true` | `true` | 留空 |
| 监听所有频道 | `true` | `false` | 留空 |
| 手动指定频道 | `false` | 任意 | 填写频道ID |

---

## 常见问题

### Q: 我设置了归档模式，但还是收到所有频道的消息？

A: 检查配置：
```bash
LISTEN_ALL_SUBSCRIBED_CHANNELS=true  # ✅ 必须是 true
LISTEN_ARCHIVED_ONLY=true            # ✅ 必须是 true
CHANNEL_ALLOWLIST=                   # ✅ 必须留空
```

### Q: 如何查看当前有哪些归档频道？

A: 停止服务后运行测试脚本：
```bash
./start.sh stop
source .venv/bin/activate
python test_archived_feature.py
```

### Q: 运行时归档新频道会立即生效吗？

A: 不会，需要重启程序：
```bash
./start.sh stop
./start.sh
```

---

## 完整配置示例

### 只监听归档频道（推荐）

```bash
# ====== .env 文件 ======

# Telegram 认证（必填）
TELEGRAM_API_ID=你的API_ID
TELEGRAM_API_HASH=你的API_HASH
TELEGRAM_PHONE_NUMBER=+1234567890

# 🔑 核心配置：只监听归档频道
LISTEN_ALL_SUBSCRIBED_CHANNELS=true
LISTEN_ARCHIVED_ONLY=true
CHANNEL_ALLOWLIST=

# 其他配置保持默认即可
BLOCK_PRIVATE_MESSAGES=false
BLOCKED_SENDER_IDS=777000
```

---

## 工作原理

```
用户归档操作 (Telegram 客户端)
        ↓
频道移动到归档文件夹 (folder_id=1)
        ↓
程序启动时检测配置
        ↓
LISTEN_ARCHIVED_ONLY=true?
        ↓ YES
只获取 folder_id=1 的对话
        ↓
监听这些频道的消息
        ↓
消息入库 (SQLite)
```

---

**提示**: 如果你不确定某个频道是否已归档，可以在 Telegram 中查看 "归档聊天" 文件夹。
